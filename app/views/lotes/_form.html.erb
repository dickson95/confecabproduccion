<div class="row">
  <div class=" col-md-12">
    <%
    place = nil
    if params[:action]=="edit"
      place = "form_edit_lote_response"
    else
      place = "form_new_lote_response"
    end
    %>
    <%= simple_form_for(@lote, 
    :url => params[:action]=="edit" ? lote_path(:place => place) : lotes_path(:place => place), 
    wrapper: :vertical_input_group,
        wrapper_mappings: {
          check_boxes: :horizontal_radio_and_checkboxes,
          radio_buttons: :horizontal_radio_and_checkboxes,
          file: :horizontal_file_input,
          boolean: :horizontal_boolean
        }) do |f| %>
        <%= f.error_notification %>
      <div class="form-inputs">
<!--Form para integración-->
        <% if @rol_form == "coor_integracion" || @rol_form == "coor_tiempos" || 
        @rol_form == "admin"%>
          <div class="row">
              <div class="panel">
                <div class="panel-heading panel-primary">
                  <h2>Integración de lote</h2>
                  <p class="text-muted">
                    Hola <%=current_user.name%>, Ingresa aquí los primeros datos para los lotes que
                    recibe nuestra empresa.
                  </p>
                </div>
              </div>
          </div>
          <!--Primera fila-->
          <div class="row">
            <div class="col-sm-9">
              <div class="col-sm-4">
                  <%= f.input :op, input_html: { style: 'text-transform:uppercase;',
                    autocomplete: 'off', autofocus: true} %>
              </div>
              <div class="col-sm-4">
                  <%if params[:action] != 'edit' %>
                      <%= f.input :referencia, input_html: { style: 'text-transform:uppercase;',
                    autocomplete: 'off'}%>
                      <span></span>
                      <div id="error_div_referencia" class="text-danger"></div>
                  <%else %>
                    <%= f.input :referencia, :readonly => true, 
                    input_html: { style: 'text-transform:uppercase;', 
                     autocomplete: 'off', value: "#{@lote.referencia.referencia}"}%>
                  <% end %>
              </div>
              <div class="col-sm-4">
                  <%  if params[:action] != 'edit' %>
                  <div class="input-group">
                    <%= f.input :cliente_id do %>
                      <%= f.input_field  :cliente_id, class: "form-control", 
                      :collection => @clientes, 
                      :value_method => :id%>
                      <div class="input-group-btn">
                        <%= link_to '...', add_remote_data_path(:place => "form_lote_cliente"),{:remote => true, 
                          'data-toggle' =>  "modal", 'data-target' => '#myModal', 
                          :class => "btn btn-primary", :title => "Nuevo cliente"} %>
                      </div>
                    <% end %>
                  </div>
                  <div id="error_div_cliente" class="text-danger"></div>
                  <%  else %>
                    <%= f.association :cliente, :disabled => true %>
                  <%  end %>
              </div>
              <div class="col-sm-4">
                <div class="input-group">
                  <%= f.input :tipo_prenda_id,  label: "Descripción" do %>
                    <%= f.input_field  :tipo_prenda_id, class: "form-control",
                    :collection => @tipos_prendas,
                    :value_method => :id %>
                    <div class="input-group-btn">
                      <%= link_to '...', add_remote_data_path(:place => "form_lote_tipo_prenda"),{:remote => true, 
                      'data-toggle' =>  "modal", 'data-target' => '#myModal', 
                      :class => "btn btn-primary", :title => "Nueva descripción"} %>
                    </div>
                  <% end %>
                </div>
              </div>
              <div class="col-sm-4">
                <div style="padding-top: 15px; padding-bottom: 19px;">
                  <%=f.label :empresa%><br>
                  <%= f.collection_radio_buttons :empresa, [['CAB'],[ 'D&C']],
                  :first, :last, item_wrapper_class: 'radio-inline', checked: 'CAB',
                  label: false%>
                </div>
              </div>
              <div class="col-sm-4" style="padding-top:15px">
                <%=f.label :fin_integracion, label: "¿Ingreso completado?"%><br>
                <%= f.collection_radio_buttons :fin_integracion, [[true, 'Sí'], [false, 'No']], 
                :first, :last, label: false,
                      item_wrapper_class: 'radio-inline', item_wrapper_tag: :label, checked: true %>
              </div>
            </div>
            <div class="col-sm-3">
                <%= f.input :obs_integracion, input_html:{:style => "height: 110px"},
                :label => 'Notas de integración'%>
            </div>
          </div>
              <div class="row">
                <div class="panel">
                  <div class="panel panel-heading"></div>
                </div>
              </div>
        <%end%>
<!--Fin zona de integración-->
       
       
<!--Zona de form para insumos-->
        <% if @rol_form == "aux_insumos" || @rol_form == "coor_tiempos" ||
        @rol_form == "admin"%>
          <div class="panel">
            <div class="panel-heading panel-primary">
              <div class="row">
                <div class="col-lg-6">
                  <h2>Insumos del lote</h2>
                  <p class="text-muted">
                    Hola <%=current_user.name%>. Por favor ingresa los datos para 
                    confirmar que los insumos se encuentran completos.
                  </p>
                </div>
                <div class="col-lg-6">
                  <%if !@lote.cliente.nil?%>
                  <div class="col-lg-3">
                    <h3>Cliente</h3>
                    <p>
                      <%=@lote.cliente.cliente%>
                    </p>
                  </div>
                  <div class="col-lg-3">
                    <h3>Referencia</h3>
                    <p>
                      <%= @lote.referencia.referencia%>
                    </p>
                  </div>
                  <%end%>
                </div>
              </div>
            </div>
          </div>
          <%if @rol_form == "aux_insumos" && params[:action]=="edit"%>
          <%= f.hidden_field :referencia, :value => "#{@lote.referencia.referencia}"%>
          <%end%>
          <div class="row">
            <!--Fila 1-->
            <div class="col-lg-12">
              <div class="col-md-4">
                <div>
                  <%if @lote.fecha_entrada.nil?%>
                    <%= f.input :fecha_entrada, as: "string", 
                    input_html: {:value => I18n::localize(Time.zone.utc_to_local(Time.new) + 60, :format => "%Y-%m-%d")},
                    readonly: true, label: 'Entró a insumos el:'  %>
                  <%else%>
                  <%=f.input :fecha_entrada, as: "string", disabled: true%>
                  <%end%>
                </div>
                <div>
                  <%= f.input :fecha_entrega, 
                  as: "string", input_html: { class: "datepicker", :autocomplete => "off" } %>
                </div>
              </div>
              <div class="col-md-4">
                <div>
                  <%= f.input :fecha_revision, as: "string", input_html: { class: "datepicker", 
                  :autocomplete => "off"  }%>
                </div>
                <div style="padding-top:15px">
                  <%= f.label :fin_insumos, label: "¿Insumos listos?"%> <br>
                  <%= f.collection_radio_buttons :fin_insumos, [[true, 'Sí'], [false, 'No']], :first, :last, label: false,
                      item_wrapper_class: 'radio-inline', item_wrapper_tag: :label, checked: true %>
                </div>
              </div>
              <div class="col-md-4">
                <%= f.input :obs_insumos, label: 'Notas de los insumos', input_html:{:style => "height: 110px"} %>
              </div>
            </div>
          </div>
<!--Form estados-->
        <%end%>
<!--Fin zona form para insumos-->    


<!--Detalle de cantidades--> 
        <div class="row">
          <div class="col-md-12">
            <div class="panel">
              <div class="panel-heading panel-default">
                <h4>Detalle de cantidad</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="table-responsive">
              <table class="table table-hover" id="table_form_lote">
                <tbody>
                  <%bool = true%>
                  <%row = ColorLote.where(:lote_id => @lote.id).count()%>
                  <%i = 0%>
                  <%=f.fields_for :colores_lotes do |color_lote|%>
                  <tr>
                    <% if bool%>
                      <th scope="rowgroup" rowspan="<%=row + 1%>" style="padding:0; margin:0;" 
                        id="row_sp_color">
                        Colores
                      </th>
                      <%bool = false%>
                    <%end%>
                    <%=render partial: 'color_lote_fields', locals: {
                      col: @colores.nil? ? "" : @colores.fetch(i), 
                      total: @totales.nil? ? "" : @totales.fetch(i),
                      f: color_lote, b: false }%>
                  </tr>
                  
                  <% i += 1 %>
                  
                  <%end%>
                </tbody>
                <%
                  # El objetivo de poner el thead debajo del tbody es 
                  # que no exista interferencia con el fields_for que hay en el 
                  # tbody
                %>
                <thead>
                  <tr class="small" title="Talla tipo A">
                    <th scope="col" rowspan="3" class="text-center">Cantidad Corte</th>
                    <th scope="col" rowspan="3">Tallas</th>
                    <%cont = 0%>
                    <%@tallas.each do |talla|%>
                      <% if cont == 0%>
                        <th scope="col" class="col-lg-1"><%=talla.talla%></th>
                      <%end%>
                      <%cont == 2 ? cont = 0 : cont = cont + 1%>
                    <%end%>
                    <th scope="col" rowspan="2" class="text-center">
                      <%
                        @colores_lotes = @lote.colores_lotes.build
                        @cantidades = @colores_lotes.cantidades.build
                      %>
                        <%= link_to_add_fields "","add_fields btn btn-primary  
                          fa fa-plus", f, :colores_lotes %>
                    </th>
                  </tr>
                  <tr class="small" title="Talla tipo B">
                    <%cont = 0%>
                    <%@tallas.each do |talla|%>
                      <% if cont == 1%>
                        <th scope="col" class="col-lg-1"><%=talla.talla%></th>
                      <%end%>
                      <%cont == 2 ? cont = 0 : cont = cont + 1%>
                    <%end%>
                  </tr>
                  <tr class="small" title="Talla tipo C">
                    <%cont = 0%>
                    <%@tallas.each do |talla|%>
                      <% if cont == 2%>
                        <th scope="col" class="col-lg-1"><%=talla.talla%></th>
                      <%end%>
                      <%cont == 2 ? cont = 0 : cont = cont + 1%>
                    <%end%>
                    <th scope="col">
                      Total colores
                    </th>
                  </tr>
                </thead>
                <tfoot>
                  <tr>
                    <th scope="row" style="padding:0; margin:0;" title="Total">Total</th>
                    <%for n in 0..9%>
                      <td style="padding:0; margin:0;">
                        <%if n > 0%>
                          <input id="total<%=n%>" class="form-control input-sm" 
                            type="number" disabled="true" title="Total de &#013;talla <%=n + (n + 4)%>"
                            value="<%= !@totales_tallas.nil? ? @totales_tallas.fetch(n - 1) : 0%>"/>
                        <%end%>
                      </td>
                    <%end%>
                    <td class="total" style="padding:0; margin:0;">
                      <%=f.input :cantidad, readonly: true, label: false,
                        input_html:{class: "input-sm", title: "Total absoluto"}%>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
        <% if @rol_form == "coor_tiempos" || @rol_form == "admin"%>
        <div class="row">
          <div class="col-lg-12">
            <div class="col-md-4">
              <%= f.input :no_remision, label: "Número de remisión" %>
            </div>
            <div class="col-md-4">
              <%= f.input :no_factura, label: "Número de factura" %>
            </div>
            <div class="col-md-4">
              <%= f.input :precio_u, label: "Precio unitario" %>
            </div>
          </div>
        </div>
        <%end%>

        <!--Detalle de estado-->
        <div class="row" id="form_lote_estado_update">
          <div class="col-lg-12">
            <div class="panel">
              <div class="panel-heading panel-default">
                <h4>Datos del proceso</h4>
              </div>
            </div>
          </div>
        
          <div class="col-lg-12">
            <%=render 'estados/form_for_lote', f: f %>
          </div>
        </div>
        <!--Fin detalle de estado-->
        
<!--Form submit-->
        <div class="row">
          <div class="col-lg-12">
            <div class="panel">
              <div class="panel-heading panel-default">
              </div>
            </div>
            <div class="form-actions text-right">
              <%= f.button :submit, :value => 'Aceptar',
              data:{:disable_with => "Guardando"}, class: 'btn-default',
              :id =>"lote_guardar" %>
              <%= link_to 'Cancelar', lotes_path, class: 'btn btn-outline btn-primary' %>
            </div>
            <div class="panel">
              <div class="panel-heading panel-primary">
              </div>
              <p class="text-right"><i class="text-danger">*</i>&nbsp;&nbsp;Campos obligatorios</p>
              <div class="panel-footer">
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
 <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" 
  aria-labelledby="myModalLabel" aria-hidden="true">
  </div>